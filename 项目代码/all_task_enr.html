<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>所有的任务页面-工程师</title>
  <link rel="stylesheet" href="CSS/communal.css">
  <link rel="stylesheet" href="CSS/all_task_enr.css">
  <link rel="stylesheet" href="sweetalert/sweetalert.css">
  <link rel="stylesheet" href="bootstrap-3.3.7-dist/css/bootstrap.css">
  <script src="js/jquery-3.2.1.js"></script>
  <script src="sweetalert/sweetalert-dev.min.js"></script>
  <script src="bootstrap-3.3.7-dist/js/bootstrap.js"></script>
  <script src="js/all_task_enr.js"></script>
</head>
<body>
<input type="hidden" id="userId" value="null">
<div class="main-div">
  <div class="above">
    <span class="txt">腾讯IT办公网新建项目</span>
  </div>
  <div class="below-div">
    <div class="left choose-tasks">
      <div class="job-navigation">任务导航</div>
      <ul>
        <li data-src="template-alltasks-enr-table/all_tasks_table.html" class="active">所有任务</li>
        <li data-src="template-alltasks-enr-table/my_task_table.html">我的任务</li>
      </ul>
    </div>
    <div class="right iframe-div">
      <iframe id="iframe-table" class="iframe-class" src="template-alltasks-enr-table/all_tasks_table.html"
              frameborder="0" scrolling="auto" onload="onMyFrameLoad()"></iframe>
    </div>
  </div>
</div>


<!--点击设置按钮展示“状态/文件更新”弹出窗口-->
<div id="showLoadingImgModel" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog"
     aria-labelledby="mySmallModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">状态/文件更新</h4>
      </div>
      <div class="modal-body">
        <form action="">
          <div class="form-group">
            状态更新：
            <select id="updates_status" class="form-control">
              <option value="1">进行中</option>
              <option value="2">已完成</option>
              <option value="3">闲置中</option>
              <option value="4">未进行</option>
            </select>
          </div>
          <div class="form-group">
            文件更新：
            <input type="file" id="InputFile">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">退出</button>
        <button type="button" class="btn btn-primary" id="StateConfirmBtn">确认</button>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  $(function () {

  });

  //监听iframe :当iframe加载完毕后绑定两个按钮的点击事件
  //“参与任务”和“设置”两个按钮
  function onMyFrameLoad() {
    // iframe加载初始化的时候，请求数据填充表格
    $.ajax({
      type: "POST",
      url: "/getTableData",
      processData: true,
      dataType: "Json",
      success: function (response) {
        swal(
          {
            title: "更新成功",
            text: "成功",
            type: "success",
            timer: 1500
          })
      },
      error: function (e) {
        //封装的一个数据类
        function trData(taskName, current_status, task_explain_file, enrs) {
          this.taskName = taskName;
          this.current_status = current_status;
          this.task_explain_file = task_explain_file;
          this.enrs = enrs
        }

        //tableJsonData为伪造的json数据
        var tableJsonData = {};
        tableJsonData.userId = 18;
        var tr1 = new trData("IP规划表检查", "已完成", "IP规划表检查.zip", "A、B");
        var tr2 = new trData("确认配置模板", "进行中", "确认配置模板.zip", "A、B、C");
        var tr3 = new trData("IP规划表检查", "闲置中", "IP规划表检查.zip", "A");
        var tr4 = new trData("确认配置模板", "已完成", "确认配置模板.zip", "A、B");
        tableJsonData.all_tasks_table_data = [tr1, tr2, tr3, tr4];
        console.log(tableJsonData);
        console.log(JSON.stringify(tableJsonData));
        //1.给隐藏域的userId 赋值
        console.log(tableJsonData.userId);
        $("#userId").val(tableJsonData.userId);
        console.log($("#userId").val());

        //2.循环遍历ajax请求到的tableJsonData填充表格
        for (let i = 0; i < tableJsonData.all_tasks_table_data.length; i++) {
          const index = i + 1;
          const result = " <tr><td>" + index + "." + tableJsonData.all_tasks_table_data[i].taskName + "</td>" +
            "<td class=\"project-status\">" + tableJsonData.all_tasks_table_data[i].current_status + "</td>" +
            "<td>" + tableJsonData.all_tasks_table_data[i].task_explain_file + "</td>" +
            "<td>" + tableJsonData.all_tasks_table_data[i].enrs + "</td>" +
            "<td><button>参与任务</button></td>" +
            "<td><button>设置</button></td>" +
            "</tr>";
          $("#iframe-table").contents().find("table")[0].insertRow(i + 1).innerHTML = result;
        }

        //绑定“参与任务”、“设置”两个按钮的点击事件
        $("#iframe-table").contents().find("table tr button")
          .each(function (index, item) {
            const taskText = $(this).parent().parent()[0].cells[0].innerText;
            //获取隐藏域的id值
            const hiddenText = $(this).parent().parent().find("input[type=hidden]").val();
            if (index % 2 == 0) {
              //每行第一个button
              item.onclick = function () {
                const userId = $("#userId").val();
                return SwalConfirm(taskText, hiddenText, userId);
              }
            } else {
              // 每行的第二个button
              const taskStatus = $(this).parent().parent()[0].cells[1].innerText;  //当前状态值
              item.onclick = function () {
                return updateBtn(taskStatus);
              }
            }
          })
      }
    });
    //绑定“参与任务”、“设置”两个按钮的点击事件
    $("#iframe-table").contents().find("table tr button")
      .each(function (index, item) {
        const taskText = $(this).parent().parent()[0].cells[0].innerText;
        //获取隐藏域的id值
        const hiddenText = $(this).parent().parent().find("input[type=hidden]").val();
        if (index % 2 == 0) {
          //每行第一个button
          item.onclick = function () {
            const userId = $("#userId").val();
            return SwalConfirm(taskText, hiddenText, userId);
          }
        } else {
          // 每行的第二个button
          const taskStatus = $(this).parent().parent()[0].cells[1].innerText;  //当前状态值
          item.onclick = function () {
            return updateBtn(taskStatus);
          }
        }
      })
  }

  // 状态/文件更新窗口 确认按钮
  $("#StateConfirmBtn").click(function () {
    //选择的文件状态值
    // 1代表：进行中
    // 2代表：已完成
    // 3代表：闲置中
    // 4代表：未进行
    const selectVal = $("#updates_status").val();
    //上传的文件
    const fileUpload = $("#InputFile")[0].files[0];
    const userId = $("#userId").val();
    const formData = new FormData();
    formData.append("selectVal", selectVal);
    formData.append("file", fileUpload);
    formData.append("userId", userId);
    // formData中的数据说明
    // parameter1.selectVal表示选择的文件状态值
    // 1代表：进行中
    // 2代表：已完成
    // 3代表：闲置中
    // 4代表：未进行
    // parameter2.file表示上传的文件
    // parameter3.userId表示用户id
    console.log(formData.get("selectVal"));
    console.log(formData.get("file"));
    console.log(formData.get("userId"));
    $.ajax({
      type: "POST",
      url: "/xxxxxxxx",
      data: formData,
      processData: false,
      dataType: "Json",
      success: function (response) {
        swal(
          {
            title: "更新成功",
            text: "成功",
            type: "success",
            timer: 1500
          })
      },
      error: function (e) {
        swal(
          {
            title: "更新失败",
            text: "后台处理错误",
            type: "error",
            timer: 1500
          })
      }
    })
    $("#showLoadingImgModel").modal('hide');
  });

  //“参与任务”按钮
  function SwalConfirm(taskText, hiddenText, userId) {
    swal(
      {
        title: taskText,
        text: "是否已与项目经理确认参与此项任务？",
        type: "warning",
        showCancelButton: true,
        confirmButtonColor: "#39dd17",
        confirmButtonText: "已经确认",
        cancelButtonText: "取消",
        closeOnConfirm: false,
        closeOnCancel: false
      },
      function (isConfirm) {
        //hiddenText 是隐藏域id，应该将该id传递至后台
        const formData = new FormData();
        formData.append("taskId", hiddenText);
        formData.append("userId", userId);
        //formData中的数据说明
        //parameter1:taskId表示参与任务ID
        //parameter2:userId表示当前登录用户
        console.log("任务id:" + formData.get("taskId"));
        console.log("用户id:" + formData.get("userId"));
        if (isConfirm) {
          $.ajax({
            type: "POST",
            url: "/xxxxx/xxx",
            processData: false,
            data: formData,
            dataType: "Json",
            success: function (response) {
              swal(
                {
                  title: "参与任务成功",
                  text: "您将参与该项任务",
                  type: "success",
                  timer: 1500
                })
            },
            error: function (e) {
              swal(
                {
                  title: "参与任务成功失败",
                  text: "后台处理错误",
                  type: "error",
                  timer: 1500
                })
            }
          })
        } else {
          swal({
            title: "已取消",
            text: "您取消了参与任务操作！",
            type: "success",
            timer: 1500
          })
        }
      }
    )
  }
</script>
</body>
</html>